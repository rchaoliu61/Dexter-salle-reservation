<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DEXTER Team Calendar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales-all.global.min.js'></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        /* --- CSS STYLES --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f4f6f8; }
        
        /* Header */
        header { background-color: #2c3e50; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;}
        h2 { margin: 0; font-size: 1.2rem; }
        
        .header-controls { display: flex; align-items: center; gap: 15px; }
        .auth-status { font-size: 0.9rem; display: flex; align-items: center; gap: 10px; }
        
        select.lang-select { padding: 5px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; }

        button { cursor: pointer; padding: 8px 12px; border: none; border-radius: 4px; font-weight: 600; }
        .btn-login { background-color: #3498db; color: white; }
        .btn-logout { background-color: #e74c3c; color: white; display: none; }

        /* Calendar Container */
        #calendar-container { max-width: 1000px; margin: 2rem auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* MODALS */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 25px; width: 320px; border-radius: 8px; position: relative; }
        .close { position: absolute; right: 15px; top: 10px; font-size: 24px; cursor: pointer; color: #aaa; }
        
        input, select { width: 100%; padding: 10px; margin: 8px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        label { font-weight: bold; font-size: 0.9rem; margin-top: 10px; display: block; }
        
        /* Time Row layout */
        .time-row { display: flex; gap: 10px; }
        .time-group { flex: 1; }

        .modal-btn { width: 100%; margin-top: 15px; padding: 10px; color: white; font-size: 1rem; }
        .btn-signin { background-color: #27ae60; }
        .btn-register { background-color: #8e44ad; }
        .btn-reset { background-color: #e67e22; }
        .btn-book { background-color: #2980b9; }
        
        .error-msg { color: red; font-size: 0.8rem; margin-top: 10px; display: none; text-align: center; }
        .success-msg { color: green; font-size: 0.8rem; margin-top: 10px; display: none; text-align: center; }
        .toggle-text { text-align: center; margin-top: 15px; font-size: 0.85rem; color: #666; cursor: pointer; text-decoration: underline; }
        .forgot-link { display: block; text-align: right; font-size: 0.8rem; color: #3498db; cursor: pointer; margin-bottom: 5px; }

        #recurrence-end-wrapper { display: none; background: #f0f0f0; padding: 10px; border-radius: 4px; margin-top: 5px; }
    </style>
</head>
<body>

    <header>
        <h2 data-i18n="app_title">ðŸ“… Room Availability</h2>
        
        <div class="header-controls">
            <select id="lang-selector" class="lang-select" onchange="changeLanguage(this.value)">
                <option value="en">English</option>
                <option value="fr">FranÃ§ais</option>
            </select>

            <div class="auth-status">
                <span id="user-display" data-i18n="guest_mode">Guest Mode</span>
                <button id="login-btn" class="btn-login" onclick="openAuthModal()" data-i18n="login_btn">Login / Sign Up</button>
                <button id="logout-btn" class="btn-logout" onclick="logout()" data-i18n="logout_btn">Logout</button>
            </div>
        </div>
    </header>

    <div id='calendar-container'>
        <div id='calendar'></div>
    </div>

    <div id="authModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('authModal')">&times;</span>
            <h3 id="auth-title" style="text-align:center; margin-top:0;" data-i18n="sign_in">Sign In</h3>
            
            <input type="email" id="email" placeholder="Email Address">
            <input type="password" id="password" placeholder="Password">
            <span id="forgot-link" class="forgot-link" onclick="toggleResetMode()" data-i18n="forgot_pass">Forgot Password?</span>

            <button id="confirm-login-btn" class="modal-btn btn-signin" onclick="handleLogin()" data-i18n="sign_in">Sign In</button>
            <button id="confirm-register-btn" class="modal-btn btn-register" onclick="handleRegister()" style="display:none;" data-i18n="create_account">Create Account</button>
            <button id="confirm-reset-btn" class="modal-btn btn-reset" onclick="handlePasswordReset()" style="display:none;" data-i18n="send_reset">Send Reset Email</button>
            
            <p id="auth-error" class="error-msg"></p>
            <p id="auth-success" class="success-msg"></p>

            <div class="toggle-text" id="toggle-mode" onclick="toggleAuthMode()" data-i18n="new_here">New here? Create an account</div>
        </div>
    </div>

    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('bookingModal')">&times;</span>
            <h3 style="text-align:center; margin-top:0;" data-i18n="new_reservation">New Reservation</h3>
            
            <label data-i18n="purpose_label">Purpose / Title:</label>
            <input type="text" id="book-title" placeholder="e.g. Dexter Team Meeting">

            <div class="time-row">
                <div class="time-group">
                    <label data-i18n="start_time_label">Start:</label>
                    <input type="time" id="start-time-input">
                </div>
                <div class="time-group">
                    <label data-i18n="end_time_label">End:</label>
                    <input type="time" id="end-time-input">
                </div>
            </div>
            
            <label data-i18n="recurrence_label">Recurrence:</label>
            <select id="recur-type" onchange="toggleRecurrenceUI()">
                <option value="none" data-i18n="recur_none">One time only</option>
                <option value="daily" data-i18n="recur_daily">Daily</option>
                <option value="weekly" data-i18n="recur_weekly">Weekly</option>
                <option value="monthly" data-i18n="recur_monthly">Monthly</option>
            </select>

            <div id="recurrence-end-wrapper">
                <label data-i18n="repeat_until">Repeat Until:</label>
                <input type="date" id="recur-end-date">
            </div>

            <button class="modal-btn btn-book" onclick="saveBooking()" data-i18n="confirm_res">Confirm Reservation</button>
            <p id="book-error" class="error-msg"></p>
        </div>
    </div>

    <script>
        // --- TRANSLATION DICTIONARY ---
        const translations = {
            en: {
                app_title: "ðŸ“… Room Availability",
                guest_mode: "Guest Mode",
                login_btn: "Login / Sign Up",
                logout_btn: "Logout",
                sign_in: "Sign In",
                create_account: "Create Account",
                forgot_pass: "Forgot Password?",
                send_reset: "Send Reset Email",
                new_here: "New here? Create an account",
                has_account: "Already have an account? Sign In",
                back_sign_in: "Back to Sign In",
                new_reservation: "New Reservation",
                purpose_label: "Purpose / Title:",
                start_time_label: "Start:",
                end_time_label: "End:",
                recurrence_label: "Recurrence:",
                recur_none: "One time only",
                recur_daily: "Daily",
                recur_weekly: "Weekly",
                recur_monthly: "Monthly",
                repeat_until: "Repeat Until:",
                confirm_res: "Confirm Reservation",
                delete_prompt_single: "Delete this reservation?",
                delete_prompt_series: "This is a recurring event. \nType '1' to delete ONLY this event. \nType '2' to delete the WHOLE SERIES.",
                series_deleted: "Series deleted.",
                access_denied: "You can only delete your own reservations.",
                conflict_msg: "Conflict detected! A future date overlaps with an existing reservation.",
                error_title: "Please add a title.",
                restricted_email: "Registration restricted to @lirmm.fr or @cnrs.fr",
                check_inbox: "Reset link sent. Check your inbox.",
                past_error: "You cannot make a reservation in the past.",
                delete_past_error: "You cannot delete a reservation that has already passed."
            },
            fr: {
                app_title: "ðŸ“… DisponibilitÃ© Salle",
                guest_mode: "Mode InvitÃ©",
                login_btn: "Connexion / Inscription",
                logout_btn: "DÃ©connexion",
                sign_in: "Se connecter",
                create_account: "CrÃ©er un compte",
                forgot_pass: "Mot de passe oubliÃ© ?",
                send_reset: "Envoyer l'email",
                new_here: "Nouveau ? CrÃ©er un compte",
                has_account: "DÃ©jÃ  un compte ? Se connecter",
                back_sign_in: "Retour Ã  la connexion",
                new_reservation: "Nouvelle RÃ©servation",
                purpose_label: "Objet / Titre :",
                start_time_label: "DÃ©but :",
                end_time_label: "Fin :",
                recurrence_label: "RÃ©pÃ©tition :",
                recur_none: "Une seule fois",
                recur_daily: "Tous les jours",
                recur_weekly: "Toutes les semaines",
                recur_monthly: "Tous les mois",
                repeat_until: "RÃ©pÃ©ter jusqu'au :",
                confirm_res: "Confirmer la rÃ©servation",
                delete_prompt_single: "Supprimer cette rÃ©servation ?",
                delete_prompt_series: "C'est un Ã©vÃ©nement rÃ©current. \nTapez '1' pour supprimer CET Ã©vÃ©nement. \nTapez '2' pour supprimer TOUTE LA SÃ‰RIE.",
                series_deleted: "SÃ©rie supprimÃ©e.",
                access_denied: "Vous ne pouvez supprimer que vos propres rÃ©servations.",
                conflict_msg: "Conflit dÃ©tectÃ© ! Une date future chevauche une rÃ©servation existante.",
                error_title: "Veuillez ajouter un titre.",
                restricted_email: "Inscription restreinte aux emails @lirmm.fr ou @cnrs.fr",
                check_inbox: "Lien envoyÃ©. VÃ©rifiez votre boÃ®te mail.",
                past_error: "Impossible de rÃ©server dans le passÃ©.",
                delete_past_error: "Impossible de supprimer une rÃ©servation passÃ©e."
            }
        };

        let currentLang = 'en'; // Default

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyDFKDD6Oc7UwVfPdUQWXnYD2I-YRKK_0Dc",
          authDomain: "dexter-salle-reservation.firebaseapp.com",
          databaseURL: "https://dexter-salle-reservation-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "dexter-salle-reservation",
          storageBucket: "dexter-salle-reservation.firebasestorage.app",
          messagingSenderId: "749673682394",
          appId: "1:749673682394:web:64fbe89d86ac0e9da45ce3",
          measurementId: "G-R6Z8QV6LH2"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const bookingsRef = db.ref('bookings');
        
        let currentUser = null;
        let authMode = 'login';
        let currentSelection = null;
        let calendarRef = null;

        // --- I18N LOGIC ---
        function changeLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    el.innerText = translations[lang][key];
                }
            });
            if (calendarRef) calendarRef.setOption('locale', lang);
            if (document.getElementById('authModal').style.display === 'block') setAuthMode(authMode);
        }
        function t(key) { return translations[currentLang][key] || key; }

        // --- AUTH LOGIC ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-display').textContent = user.email;
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'block';
                closeModal('authModal');
            } else {
                currentUser = null;
                document.getElementById('user-display').textContent = t('guest_mode');
                document.getElementById('login-btn').style.display = 'block';
                document.getElementById('logout-btn').style.display = 'none';
            }
        });

        function handleLogin() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => showAuthMsg(err.message, true));
        }

        function handleRegister() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            if (!e.endsWith("@lirmm.fr") && !e.endsWith("@cnrs.fr")) {
                showAuthMsg(t('restricted_email'), true);
                return;
            }
            auth.createUserWithEmailAndPassword(e, p).then(() => showAuthMsg("Success!", false)).catch(err => showAuthMsg(err.message, true));
        }

        function handlePasswordReset() {
            const e = document.getElementById('email').value;
            if(!e) return showAuthMsg("Enter email first.", true);
            auth.sendPasswordResetEmail(e).then(() => showAuthMsg(t('check_inbox'), false)).catch(err => showAuthMsg(err.message, true));
        }
        function logout() { auth.signOut(); }

        // --- CALENDAR SETUP ---
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            calendarRef = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                slotMinTime: '08:00:00',
                slotMaxTime: '20:00:00',
                allDaySlot: false,
                selectable: true,
                height: 'auto',
                firstDay: 1, 
                locale: 'en',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },

                select: function(info) {
                    if (!currentUser) { openAuthModal(); return; }
                    
                    if (new Date(info.start) < new Date()) {
                        alert(t('past_error'));
                        calendarRef.unselect();
                        return;
                    }

                    currentSelection = info;
                    openBookingModal();
                },

                eventClick: function(info) {
                    if (!currentUser) { alert(t('sign_in')); return; }
                    const eventData = info.event.extendedProps;
                    
                    if (info.event.start < new Date()) {
                        alert(t('delete_past_error'));
                        return;
                    }

                    if (eventData.userId !== currentUser.uid) {
                        alert(t('access_denied'));
                        return;
                    }

                    if (eventData.seriesId) {
                        let choice = prompt(t('delete_prompt_series'));
                        if (choice === '1') {
                            bookingsRef.child(info.event.id).remove();
                            info.event.remove();
                        } else if (choice === '2') {
                            bookingsRef.orderByChild('seriesId').equalTo(eventData.seriesId).once('value', snapshot => {
                                const updates = {};
                                snapshot.forEach(child => {
                                    updates[child.key] = null;
                                    const evt = calendarRef.getEventById(child.key);
                                    if(evt) evt.remove();
                                });
                                bookingsRef.update(updates);
                                alert(t('series_deleted'));
                            });
                        }
                    } else {
                        if(confirm(t('delete_prompt_single'))) {
                            bookingsRef.child(info.event.id).remove();
                            info.event.remove();
                        }
                    }
                }
            });

            calendarRef.render();

            bookingsRef.on('child_added', (snapshot) => {
                const data = snapshot.val();
                calendarRef.addEvent({
                    id: snapshot.key,
                    title: data.title,
                    start: data.start,
                    end: data.end,
                    extendedProps: { userId: data.userId, seriesId: data.seriesId },
                    backgroundColor: (currentUser && data.userId === currentUser.uid) ? '#3498db' : '#95a5a6',
                    borderColor: 'transparent'
                });
            });

            bookingsRef.on('child_removed', (snapshot) => {
                const event = calendarRef.getEventById(snapshot.key);
                if (event) event.remove();
            });
        });

        // --- HELPER FOR TIME FORMAT ---
        function toTimeStr(date) {
            let h = date.getHours().toString().padStart(2, '0');
            let m = date.getMinutes().toString().padStart(2, '0');
            return h + ":" + m;
        }

        // --- BOOKING LOGIC ---
        function openBookingModal() {
            document.getElementById('bookingModal').style.display = 'block';
            document.getElementById('book-title').value = "";
            document.getElementById('book-error').style.display = 'none';
            document.getElementById('recur-type').value = "none";
            toggleRecurrenceUI();
            
            // Recurrence End Date Default (1 Month)
            let d = new Date(); d.setMonth(d.getMonth() + 1);
            document.getElementById('recur-end-date').valueAsDate = d;

            // --- TIME PICKER LOGIC ---
            let s = new Date(currentSelection.start);
            let e = new Date(currentSelection.end);
            
            // Check if this was a Month View click (Midnight to Midnight next day)
            // If hours are 00:00, we provide a smart default (e.g., 9am - 10am)
            // instead of leaving it at midnight.
            const isMidnight = (s.getHours() === 0 && s.getMinutes() === 0 && e.getHours() === 0);

            if (isMidnight) {
                document.getElementById('start-time-input').value = "09:00";
                document.getElementById('end-time-input').value = "10:00";
            } else {
                document.getElementById('start-time-input').value = toTimeStr(s);
                document.getElementById('end-time-input').value = toTimeStr(e);
            }
        }

        function toggleRecurrenceUI() {
            const type = document.getElementById('recur-type').value;
            document.getElementById('recurrence-end-wrapper').style.display = (type !== 'none') ? 'block' : 'none';
        }

        async function saveBooking() {
            const title = document.getElementById('book-title').value;
            const recurType = document.getElementById('recur-type').value;
            const recurEnd = document.getElementById('recur-end-date').value;
            
            // Get Time Inputs
            const sTimeVal = document.getElementById('start-time-input').value;
            const eTimeVal = document.getElementById('end-time-input').value;

            if(!title) {
                document.getElementById('book-error').innerText = t('error_title');
                document.getElementById('book-error').style.display = 'block';
                return;
            }

            const eventsToCreate = [];
            
            // We use the DATE from the selection, but the TIME from the inputs
            let baseDate = new Date(currentSelection.start);
            let [sh, sm] = sTimeVal.split(':').map(Number);
            let [eh, em] = eTimeVal.split(':').map(Number);

            // Create initial start/end objects
            let loopStart = new Date(baseDate);
            loopStart.setHours(sh, sm, 0);

            let loopEnd = new Date(baseDate);
            loopEnd.setHours(eh, em, 0);

            // Handle Overnight (e.g. 11pm to 1am)
            if (loopEnd <= loopStart) {
                loopEnd.setDate(loopEnd.getDate() + 1);
            }

            const seriesId = (recurType !== 'none') ? Date.now().toString() + Math.random().toString(36).substr(2, 9) : null;
            const finalDate = (recurType !== 'none') ? new Date(recurEnd) : new Date(loopStart);
            finalDate.setHours(23, 59, 59);

            while (loopStart <= finalDate) {
                eventsToCreate.push({
                    title: title + " (" + currentUser.email.split('@')[0] + ")",
                    start: loopStart.toISOString(),
                    end: loopEnd.toISOString(),
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    seriesId: seriesId
                });

                if (recurType === 'none') break; 

                if (recurType === 'daily') {
                    loopStart.setDate(loopStart.getDate() + 1); loopEnd.setDate(loopEnd.getDate() + 1);
                } else if (recurType === 'weekly') {
                    loopStart.setDate(loopStart.getDate() + 7); loopEnd.setDate(loopEnd.getDate() + 7);
                } else if (recurType === 'monthly') {
                    loopStart.setMonth(loopStart.getMonth() + 1); loopEnd.setMonth(loopEnd.getMonth() + 1);
                }
            }

            const existingEvents = calendarRef.getEvents();
            let hasConflict = false;
            for (let newEvt of eventsToCreate) {
                let newS = new Date(newEvt.start);
                let newE = new Date(newEvt.end);
                for (let existEvt of existingEvents) {
                    let exS = existEvt.start;
                    let exE = existEvt.end;
                    if (newS < exE && newE > exS) {
                        hasConflict = true;
                        break;
                    }
                }
                if(hasConflict) break;
            }

            if (hasConflict) {
                document.getElementById('book-error').innerText = t('conflict_msg');
                document.getElementById('book-error').style.display = 'block';
                return;
            }

            const updates = {};
            eventsToCreate.forEach(evt => {
                const newKey = bookingsRef.push().key;
                updates[newKey] = evt;
            });

            bookingsRef.update(updates).then(() => {
                closeModal('bookingModal');
                calendarRef.unselect();
            }).catch(err => alert("Error: " + err.message));
        }

        // --- UI HELPERS ---
        function openAuthModal() { document.getElementById('authModal').style.display = 'block'; setAuthMode('login'); }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function showAuthMsg(msg, isErr) {
            const e = document.getElementById('auth-error');
            const s = document.getElementById('auth-success');
            if(isErr) { e.innerText = msg; e.style.display='block'; s.style.display='none'; }
            else { s.innerText = msg; s.style.display='block'; e.style.display='none'; }
        }
        
        function toggleAuthMode() { setAuthMode(authMode === 'login' ? 'register' : 'login'); }
        function toggleResetMode() { setAuthMode('reset'); }
        
        function setAuthMode(m) {
            authMode = m;
            document.getElementById('auth-error').style.display='none';
            document.getElementById('auth-success').style.display='none';
            const tElem = document.getElementById('auth-title');
            const p = document.getElementById('password');
            const bL = document.getElementById('confirm-login-btn');
            const bR = document.getElementById('confirm-register-btn');
            const bRe = document.getElementById('confirm-reset-btn');
            const fL = document.getElementById('forgot-link');
            const tog = document.getElementById('toggle-mode');

            if(m==='login'){ tElem.innerText = t('sign_in'); p.style.display='block'; bL.style.display='block'; bR.style.display='none'; bRe.style.display='none'; fL.style.display='block'; tog.innerText = t('new_here'); }
            else if(m==='register'){ tElem.innerText = t('create_account'); p.style.display='block'; bL.style.display='none'; bR.style.display='block'; bRe.style.display='none'; fL.style.display='none'; tog.innerText = t('has_account'); }
            else if(m==='reset'){ tElem.innerText = "Reset Password"; p.style.display='none'; bL.style.display='none'; bR.style.display='none'; bRe.style.display='block'; fL.style.display='none'; tog.innerText = t('back_sign_in'); }
        }
    </script>
</body>
</html>
